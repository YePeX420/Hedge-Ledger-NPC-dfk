<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hedge Ledger Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #f1f5f9;
        }
        
        .subtitle {
            color: #94a3b8;
            margin-bottom: 2rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: #1e293b;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid #334155;
        }
        
        .metric-card h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .metric-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }
        
        .metric-card .subtext {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .data-section {
            background: #1e293b;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #334155;
        }
        
        .data-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #f1f5f9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 500;
            border-bottom: 1px solid #334155;
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #334155;
            font-size: 0.875rem;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success {
            background: #10b981;
            color: #fff;
        }
        
        .badge-pending {
            background: #64748b;
            color: #fff;
        }
        
        .badge-free {
            background: #475569;
            color: #e2e8f0;
        }
        
        .badge-tier {
            background: #3b82f6;
            color: #fff;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hedge Ledger Analytics</h1>
        <p class="subtitle">Real-time metrics for your DeFi Kingdoms Discord bot</p>
        
        <div id="loading" class="loading">Loading...</div>
        
        <div id="content" style="display: none;">
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Players</h3>
                    <div class="value" id="total-players">0</div>
                    <div class="subtext" id="with-balance">0 with active balances</div>
                </div>
                
                <div class="metric-card">
                    <h3>JEWEL Deposits</h3>
                    <div class="value" id="total-jewel">0</div>
                    <div class="subtext" id="completed-deposits">0 completed deposits</div>
                </div>
                
                <div class="metric-card">
                    <h3>Total Revenue</h3>
                    <div class="value" id="total-revenue">$0</div>
                    <div class="subtext" id="total-profit">Profit: $0</div>
                </div>
                
                <div class="metric-card">
                    <h3>Total Queries</h3>
                    <div class="value" id="total-queries">0</div>
                    <div class="subtext" id="paid-queries">0 paid queries</div>
                </div>
            </div>
            
            <div class="data-section">
                <h2>Recent Players</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Tier</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="players-table"></tbody>
                </table>
            </div>
            
            <div class="data-section">
                <h2>Recent Deposits</h2>
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table"></tbody>
                </table>
            </div>
            
            <div class="data-section">
                <h2>Query Type Breakdown</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Query Type</th>
                            <th>Total</th>
                            <th>Free Tier</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="queries-table"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        async function loadDashboard() {
            try {
                const [overview, players, deposits, queries] = await Promise.all([
                    fetch('/api/analytics/overview').then(r => r.json()),
                    fetch('/api/analytics/players?limit=5').then(r => r.json()),
                    fetch('/api/analytics/deposits?limit=5').then(r => r.json()),
                    fetch('/api/analytics/query-breakdown').then(r => r.json())
                ]);
                
                document.getElementById('total-players').textContent = overview.players.total;
                document.getElementById('with-balance').textContent = `${overview.players.withBalance} with active balances`;
                
                document.getElementById('total-jewel').textContent = parseFloat(overview.deposits.totalJewel).toFixed(2);
                document.getElementById('completed-deposits').textContent = `${overview.deposits.completed} completed deposits`;
                
                document.getElementById('total-revenue').textContent = '$' + parseFloat(overview.revenue.totalRevenue).toFixed(2);
                document.getElementById('total-profit').textContent = 'Profit: $' + parseFloat(overview.revenue.totalProfit).toFixed(2);
                
                document.getElementById('total-queries').textContent = overview.revenue.totalQueries;
                document.getElementById('paid-queries').textContent = `${overview.revenue.paidQueries} paid queries`;
                
                const playersTable = document.getElementById('players-table');
                playersTable.innerHTML = players.map(p => `
                    <tr>
                        <td>${p.discordUsername}</td>
                        <td><span class="badge ${p.tier === 'free' ? 'badge-free' : 'badge-tier'}">${p.tier || 'free'}</span></td>
                        <td>${parseFloat(p.balance || 0).toFixed(2)} JEWEL</td>
                    </tr>
                `).join('') || '<tr><td colspan="3">No players yet</td></tr>';
                
                const depositsTable = document.getElementById('deposits-table');
                depositsTable.innerHTML = deposits.map(d => `
                    <tr>
                        <td>${d.discordUsername || `Player #${d.playerId}`}</td>
                        <td>${parseFloat(d.requestedAmountJewel || d.requestedAmount || 0).toFixed(2)} JEWEL</td>
                        <td><span class="badge ${d.status === 'completed' ? 'badge-success' : 'badge-pending'}">${d.status}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="3">No deposits yet</td></tr>';
                
                const queriesTable = document.getElementById('queries-table');
                queriesTable.innerHTML = queries.map(q => `
                    <tr>
                        <td>${q.queryType}</td>
                        <td>${parseInt(q.count) || 0}</td>
                        <td>${parseInt(q.freeTier) || 0}</td>
                        <td>$${parseFloat(q.totalRevenue || 0).toFixed(2)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4">No queries yet</td></tr>';
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading dashboard: ' + error.message;
            }
        }
        
        loadDashboard();
        
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
